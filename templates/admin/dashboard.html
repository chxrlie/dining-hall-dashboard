{% extends "base.html" %} {% block title %}Admin Dashboard - Dining Hall{%
endblock %} {% block content %}
<div class="admin-dashboard">
  <h1>Admin Dashboard</h1>
  <p>
    Welcome, {{ session.username }}! Manage menu items and site notices here.
  </p>
  <div id="status-message" class="status-message" style="display: none"></div>

  <!-- Menu Items Management Section -->
  <section class="management-section">
    <h2>Menu Items Management</h2>

    <!-- Add New Menu Item Form -->
    <div class="form-container">
      <h3>Add New Menu Item</h3>
      <form id="addMenuItemForm" method="post" action="/api/items">
        <div class="form-group">
          <label for="name">Name:</label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="category">Category:</label>
          <select id="category" name="category" class="form-control" required>
            <option value="Mains">Mains</option>
            <option value="Sides">Sides</option>
            <option value="Desserts">Desserts</option>
            <option value="Beverages">Beverages</option>
          </select>
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea
            id="description"
            name="description"
            class="form-control"
            required
          ></textarea>
        </div>
        <div class="form-group">
          <label for="allergens">Allergens (comma-separated):</label>
          <input
            type="text"
            id="allergens"
            name="allergens"
            class="form-control"
            placeholder="e.g., gluten, dairy, nuts"
          />
        </div>
        <div class="form-group">
          <label for="is_available">Available:</label>
          <input
            type="checkbox"
            id="is_available"
            name="is_available"
            checked
          />
        </div>
        <button type="submit" class="btn btn-primary">Add Menu Item</button>
      </form>
    </div>

    <!-- Menu Items Table -->
    <div class="table-container">
      <h3>Existing Menu Items</h3>
      <div class="table-actions" style="margin-bottom: var(--spacing-md);">
        <button class="btn btn-primary" id="selectAllBtn" aria-label="Toggle all menu items" type="button">Toggle All</button>
        <button class="btn btn-warning" id="deselectAllBtn" aria-label="Deselect all menu items" type="button">Deselect All</button>
      </div>
      <table class="items-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Available</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in menu_items %}
          <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.category }}</td>
            <td>
              <input
                type="checkbox"
                class="availability-toggle"
                data-item-id="{{ item.id }}"
                {%
                if
                item.is_available
                %}checked{%
                endif
                %}
                aria-label="Toggle availability for {{ item.name }}"
              />
            </td>
            <td>
              <button
                class="btn btn-secondary"
                onclick="editMenuItem('{{ item.id }}')"
              >
                Edit
              </button>
              <button
                class="btn btn-error"
                onclick="deleteMenuItem('{{ item.id }}')"
              >
                Delete
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Notices Management Section -->
  <section class="management-section">
    <h2>Notices Management</h2>

    <!-- Add New Notice Form -->
    <div class="form-container">
      <h3>Add New Notice</h3>
      <form id="addNoticeForm" method="post" action="/api/notices">
        <div class="form-group">
          <label for="title">Title:</label>
          <input
            type="text"
            id="title"
            name="title"
            class="form-control"
            required
          />
        </div>
        <div class="form-group">
          <label for="content">Content:</label>
          <textarea
            id="content"
            name="content"
            class="form-control"
            required
          ></textarea>
        </div>
        <div class="form-group">
          <label for="is_active">Active:</label>
          <input type="checkbox" id="is_active" name="is_active" checked />
        </div>
        <button type="submit" class="btn btn-primary">Add Notice</button>
      </form>
    </div>

    <!-- Notices Table -->
    <div class="table-container">
      <h3>Existing Notices</h3>
      <table class="notices-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Content</th>
            <th>Active</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for notice in notices %}
          <tr>
            <td>{{ notice.title }}</td>
            <td>{{ notice.content|truncate(length=50) }}</td>
            <td>{% if notice.is_active %}Yes{% else %}No{% endif %}</td>
            <td>{{ notice.created_at | date(format="%Y-%m-%d %H:%M") }}</td>
            <td>
              <button
                class="btn btn-secondary"
                onclick="editNotice('{{ notice.id }}')"
              >
                Edit
              </button>
              <button
                class="btn btn-error"
                onclick="deleteNotice('{{ notice.id }}')"
              >
                Delete
              </button>
              <button
                class="btn btn-warning"
                onclick="toggleNotice('{{ notice.id }}', '{{ notice.is_active }}')"
              >
                {% if notice.is_active %}Deactivate{% else %}Activate{% endif %}
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Menu Presets Management Section -->
  <section class="management-section">
    <h2>Menu Presets Management</h2>
    <p>Manage predefined menu combinations for scheduled meals.</p>
    <a href="/admin/presets" class="btn btn-primary">Manage Menu Presets</a>
  </section>

  <!-- Menu Schedules Management Section -->
  <section class="management-section">
    <h2>Menu Schedules Management</h2>
    <p>Manage scheduled menu changes and recurring meal plans.</p>
    <a href="/admin/schedules" class="btn btn-primary">Manage Menu Schedules</a>
  </section>
</div>

<script>
  // JavaScript functions for dynamic operations
  async function deleteMenuItem(id) {
    if (confirm("Are you sure you want to delete this menu item?")) {
      try {
        const response = await fetch(`/api/items/${id}`, {
          method: "DELETE",
          credentials: "include",
        });
        if (response.ok) {
          alert("Menu item deleted successfully");
          location.reload();
        } else {
          const errorText = await response.text();
          console.error("Server error:", errorText);
          alert("Error deleting menu item: " + errorText);
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("Error deleting menu item: " + error.message);
      }
    }
  }

  async function deleteNotice(id) {
    if (confirm("Are you sure you want to delete this notice?")) {
      try {
        const response = await fetch(`/api/notices/${id}`, {
          method: "DELETE",
          credentials: "include",
        });
        if (response.ok) {
          alert("Notice deleted successfully");
          location.reload();
        } else {
          const errorText = await response.text();
          console.error("Server error:", errorText);
          alert("Error deleting notice: " + errorText);
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("Error deleting notice: " + error.message);
      }
    }
  }

  async function toggleItemAvailability(id, isAvailable) {
    // Show loading state
    const checkbox = document.querySelector(`input[data-item-id="${id}"]`);
    const statusMessage = document.getElementById("status-message");

    if (checkbox) {
      checkbox.disabled = true;
    }

    try {
      const response = await fetch(`/api/items/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          is_available: isAvailable,
        }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Server error:", errorText);

        // Show error message
        if (statusMessage) {
          statusMessage.textContent = `Error updating item availability: ${errorText}`;
          statusMessage.className = "status-message error";
          statusMessage.style.display = "block";
          setTimeout(() => {
            statusMessage.style.display = "none";
          }, 3000);
        } else {
          alert("Error updating item availability: " + errorText);
        }

        // Revert the checkbox state
        if (checkbox) {
          checkbox.checked = !isAvailable;
        }
        return false;
      }

      // Parse the response to get the updated item
      const updatedItem = await response.json();

      // Update the checkbox state on success
      if (checkbox) {
        checkbox.checked = isAvailable;
        // Add visual feedback
        checkbox.classList.add("update-success");
        setTimeout(() => {
          checkbox.classList.remove("update-success");
        }, 1000);

        // Re-enable the checkbox
        checkbox.disabled = false;
      }

      // Show success feedback
      if (statusMessage) {
        statusMessage.textContent = `Item "${updatedItem.name}" availability updated successfully`;
        statusMessage.className = "status-message success";
        statusMessage.style.display = "block";
        setTimeout(() => {
          statusMessage.style.display = "none";
        }, 3000);
      }

      console.log("Item availability updated successfully:", updatedItem);
      return true;
    } catch (error) {
      console.error("Fetch error:", error);

      // Show error message
      if (statusMessage) {
        statusMessage.textContent = `Error updating item availability: ${error.message}`;
        statusMessage.className = "status-message error";
        statusMessage.style.display = "block";
        setTimeout(() => {
          statusMessage.style.display = "none";
        }, 3000);
      } else {
        alert("Error updating item availability: " + error.message);
      }

      // Revert the checkbox state
      if (checkbox) {
        checkbox.checked = !isAvailable;
        checkbox.disabled = false;
      }
      return false;
    }
  }

  async function toggleNotice(id, currentStatus) {
    const isActive = currentStatus === "true"; // Convert string to boolean
    try {
      const response = await fetch(`/api/notices/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify({
          is_active: !isActive,
        }),
      });
      if (response.ok) {
        alert("Notice status updated successfully");
        location.reload();
      } else {
        const errorText = await response.text();
        console.error("Server error:", errorText);
        alert("Error updating notice status: " + errorText);
      }
    } catch (error) {
      console.error("Fetch error:", error);
      alert("Error updating notice status: " + error.message);
    }
  }

  async function editMenuItem(id) {
    try {
      // Fetch the menu item data
      const response = await fetch(`/api/items`);
      const items = await response.json();
      const item = items.find((i) => i.id === id);

      if (!item) {
        alert("Menu item not found");
        return;
      }

      // Create and show edit modal
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Edit Menu Item</h3>
          <form id="editMenuItemForm">
            <input type="hidden" name="id" value="${item.id}" />
            <div class="form-group">
              <label for="edit-name">Name:</label>
              <input type="text" id="edit-name" name="name" value="${
                item.name
              }" required />
            </div>
            <div class="form-group">
              <label for="edit-category">Category:</label>
              <select id="edit-category" name="category" required>
                <option value="Mains" ${
                  item.category === "Mains" ? "selected" : ""
                }>Mains</option>
                <option value="Sides" ${
                  item.category === "Sides" ? "selected" : ""
                }>Sides</option>
                <option value="Desserts" ${
                  item.category === "Desserts" ? "selected" : ""
                }>Desserts</option>
                <option value="Beverages" ${
                  item.category === "Beverages" ? "selected" : ""
                }>Beverages</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-description">Description:</label>
              <textarea id="edit-description" name="description" required>${
                item.description
              }</textarea>
            </div>
            <div class="form-group">
              <label for="edit-allergens">Allergens (comma-separated):</label>
              <input
                type="text"
                id="edit-allergens"
                name="allergens"
                value="${item.allergens.join(", ")}"
                placeholder="e.g., gluten, dairy, nuts"
              />
            </div>
            <div class="form-group">
              <label for="edit-is_available">Available:</label>
              <input
                type="checkbox"
                id="edit-is_available"
                name="is_available"
                ${item.is_available ? "checked" : ""}
              />
            </div>
            <div class="form-actions">
              <button type="button" onclick="closeModal()">Cancel</button>
              <button type="submit">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle form submission
      document
        .getElementById("editMenuItemForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = {
            name: formData.get("name"),
            category: formData.get("category"),
            description: formData.get("description"),
            allergens: formData.get("allergens")
              ? formData
                  .get("allergens")
                  .split(",")
                  .map((a) => a.trim())
                  .filter((a) => a)
              : [],
            is_available: formData.has("is_available"),
          };

          try {
            const updateResponse = await fetch(`/api/items/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify(data),
            });

            if (updateResponse.ok) {
              alert("Menu item updated successfully");
              closeModal();
              location.reload();
            } else {
              const error = await updateResponse.json();
              alert(`Error updating menu item: ${error.error}`);
            }
          } catch (error) {
            alert("Error updating menu item");
          }
        });
    } catch (error) {
      alert("Error loading menu item data");
    }
  }

  function closeModal() {
    const modal = document.querySelector(".modal");
    if (modal) {
      modal.remove();
    }
  }

  async function editNotice(id) {
    try {
      // Fetch the notice data
      const response = await fetch(`/api/notices`);
      const notices = await response.json();
      const notice = notices.find((n) => n.id === id);

      if (!notice) {
        alert("Notice not found");
        return;
      }

      // Create and show edit modal
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Edit Notice</h3>
          <form id="editNoticeForm">
            <input type="hidden" name="id" value="${notice.id}" />
            <div class="form-group">
              <label for="edit-title">Title:</label>
              <input type="text" id="edit-title" name="title" class="form-control" value="${notice.title}" required />
            </div>
            <div class="form-group">
              <label for="edit-content">Content:</label>
              <textarea id="edit-content" name="content" class="form-control" required>${notice.content}</textarea>
            </div>
            <div class="form-group">
              <label for="edit-is_active">Active:</label>
              <input
                type="checkbox"
                id="edit-is_active"
                name="is_active"
                ${notice.is_active ? "checked" : ""}
              />
            </div>
            <div class="form-actions">
              <button type="button" class="btn" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Handle form submission
      document
        .getElementById("editNoticeForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = {
            title: formData.get("title"),
            content: formData.get("content"),
            is_active: formData.has("is_active"),
          };

          try {
            const updateResponse = await fetch(`/api/notices/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify(data),
            });

            if (updateResponse.ok) {
              alert("Notice updated successfully");
              closeModal();
              location.reload();
            } else {
              const error = await updateResponse.json();
              alert(`Error updating notice: ${error.error}`);
            }
          } catch (error) {
            alert("Error updating notice");
          }
        });
    } catch (error) {
      alert("Error loading notice data");
    }
  }

  // Handle form submissions with fetch API
  function addMenuItemFormHandler(e) {
    e.preventDefault();
    console.log("Add menu item form submitted");
    const formData = new FormData(e.target);
    const data = {
      name: formData.get("name"),
      category: formData.get("category"),
      description: formData.get("description"),
      allergens: formData.get("allergens")
        ? formData
            .get("allergens")
            .split(",")
            .map((a) => a.trim())
            .filter((a) => a)
        : [],
      is_available: formData.has("is_available"), // Check if checkbox is checked
    };
    console.log("Form data:", data);

    try {
      console.log("DEBUG: About to send fetch request to /api/items");
      fetch("/api/items", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify(data),
      })
        .then((response) => {
          console.log("DEBUG: Received response from server:", response);
          if (response.ok) {
            console.log("DEBUG: Response is OK, showing alert and reloading");
            alert("Menu item added successfully");
            console.log("DEBUG: About to reload page");
            location.reload();
            console.log("DEBUG: Page reload initiated");
          } else {
            return response.text().then((errorText) => {
              console.error("Server error:", errorText);
              alert("Error adding menu item: " + errorText);
            });
          }
        })
        .catch((error) => {
          console.error("Fetch error:", error);
          alert("Error adding menu item: " + error.message);
        });
    } catch (error) {
      console.error("Error in form handler:", error);
      alert("Error adding menu item: " + error.message);
    }
  }

  function addNoticeFormHandler(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
      title: formData.get("title"),
      content: formData.get("content"),
      is_active: formData.has("is_active"),
    };

    try {
      fetch("/api/notices", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify(data),
      })
        .then((response) => {
          if (response.ok) {
            alert("Notice added successfully");
            location.reload();
          } else {
            alert("Error adding notice");
          }
        })
        .catch((error) => {
          alert("Error adding notice");
        });
    } catch (error) {
      alert("Error adding notice");
    }
  }

  async function selectAllItems() {
    const toggles = document.querySelectorAll('.availability-toggle');
    let selectedCount = 0;
    const statusMessage = document.getElementById("status-message");
    const btn = document.getElementById('selectAllBtn');

    // Show loading state
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Toggling...';
    }

    for (const toggle of toggles) {
      if (!toggle.checked) {
        const itemId = toggle.getAttribute('data-item-id');
        const success = await toggleItemAvailability(itemId, true);
        if (success) {
          selectedCount++;
          // Ensure checkbox is checked
          toggle.checked = true;
        }
      }
    }

    // Show feedback
    if (statusMessage) {
      if (selectedCount > 0) {
        statusMessage.textContent = `Successfully toggled ${selectedCount} item(s)`;
        statusMessage.className = "status-message success";
      } else {
        statusMessage.textContent = "All items are already selected";
        statusMessage.className = "status-message error";
      }
      statusMessage.style.display = "block";
      setTimeout(() => {
        statusMessage.style.display = "none";
      }, 3000);
    }

    // Re-enable button
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Toggle All';
    }
  }

  async function deselectAllItems() {
    const toggles = document.querySelectorAll('.availability-toggle');
    let deselectedCount = 0;
    const statusMessage = document.getElementById("status-message");
    const btn = document.getElementById('deselectAllBtn');

    // Show loading state
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Deselecting...';
    }

    for (const toggle of toggles) {
      if (toggle.checked) {
        const itemId = toggle.getAttribute('data-item-id');
        const success = await toggleItemAvailability(itemId, false);
        if (success) {
          deselectedCount++;
          // Ensure checkbox is unchecked
          toggle.checked = false;
        }
      }
    }

    // Show feedback
    if (statusMessage) {
      if (deselectedCount > 0) {
        statusMessage.textContent = `Successfully deselected ${deselectedCount} item(s)`;
        statusMessage.className = "status-message success";
      } else {
        statusMessage.textContent = "No items were selected to deselect";
        statusMessage.className = "status-message error";
      }
      statusMessage.style.display = "block";
      setTimeout(() => {
        statusMessage.style.display = "none";
      }, 3000);
    }

    // Re-enable button
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Deselect All';
    }
  }

  // Add event listeners with error handling
  document.addEventListener("DOMContentLoaded", function () {
    const addMenuItemForm = document.getElementById("addMenuItemForm");
    if (addMenuItemForm) {
      addMenuItemForm.addEventListener("submit", addMenuItemFormHandler);
    } else {
      console.error("Add menu item form not found");
    }

    const addNoticeForm = document.getElementById("addNoticeForm");
    if (addNoticeForm) {
      addNoticeForm.addEventListener("submit", addNoticeFormHandler);
    } else {
      console.error("Add notice form not found");
    }

    // Add event listener for select all button
    const selectAllBtn = document.getElementById("selectAllBtn");
    if (selectAllBtn) {
      selectAllBtn.addEventListener("click", selectAllItems);
    } else {
      console.error("Select all button not found");
    }

    // Add event listener for deselect all button
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    if (deselectAllBtn) {
      deselectAllBtn.addEventListener("click", deselectAllItems);
    } else {
      console.error("Deselect all button not found");
    }

    // Add event listeners for availability toggle checkboxes
    const availabilityToggles = document.querySelectorAll(
      ".availability-toggle"
    );
    availabilityToggles.forEach((toggle) => {
      toggle.addEventListener("change", async function () {
        const itemId = this.getAttribute("data-item-id");
        const isAvailable = this.checked;
        await toggleItemAvailability(itemId, isAvailable);
      });
    });
  });
</script>
{% endblock %}
