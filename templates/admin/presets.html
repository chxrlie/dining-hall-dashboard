{% extends "base.html" %} {% block title %}Menu Presets - Admin Dashboard -
Dining Hall{% endblock %} {% block content %}
<div class="admin-section">
  <h2>Menu Presets</h2>
  <button
    id="createPresetBtn"
    class="btn btn-primary"
    aria-label="Create new menu preset"
  >
    Create New Preset
  </button>
  <div class="table-container">
    <table class="items-table" aria-label="Menu presets table">
      <thead>
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Description</th>
          <th scope="col">Menu Items</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="presetsTableBody">
        <!-- Presets will be populated by JavaScript -->
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Preset Modal -->
<div
  id="editPresetModal"
  class="modal"
  style="display: none"
  role="dialog"
  aria-labelledby="modalTitle"
  aria-modal="true"
>
  <div class="modal-content">
    <h3 id="modalTitle">Create New Preset</h3>
    <form id="editPresetForm">
      <input type="hidden" id="presetId" name="id" value="" />
      <div class="form-group">
        <label for="presetName">Name:</label>
        <input
          type="text"
          id="presetName"
          name="name"
          class="form-control"
          required
          aria-required="true"
        />
      </div>
      <div class="form-group">
        <label for="presetDescription">Description:</label>
        <textarea
          id="presetDescription"
          name="description"
          class="form-control"
          required
          aria-required="true"
        ></textarea>
      </div>
      <div class="form-group">
        <label for="menuItems">Menu Items:</label>
        <div
          id="menuItemsContainer"
          role="group"
          aria-label="Menu items selection"
        >
          <!-- Menu items will be populated by JavaScript -->
        </div>
      </div>
      <div class="form-actions">
        <button
          type="button"
          id="cancelPresetBtn"
          class="btn btn-secondary"
          aria-label="Cancel and close dialog"
        >
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" aria-label="Save preset">
          Save Preset
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Global variables
  let menuItems = [];
  let presets = [];

  // DOM Elements
  const presetsTableBody = document.getElementById("presetsTableBody");
  const editPresetModal = document.getElementById("editPresetModal");
  const editPresetForm = document.getElementById("editPresetForm");
  const createPresetBtn = document.getElementById("createPresetBtn");
  const cancelPresetBtn = document.getElementById("cancelPresetBtn");
  const modalTitle = document.getElementById("modalTitle");

  // Initialize the page
  document.addEventListener("DOMContentLoaded", async function () {
    try {
      // Load menu items and presets
      await loadMenuItems();
      await loadPresets();

      // Render the presets table
      renderPresetsTable();

      // Add event listeners
      createPresetBtn.addEventListener("click", openCreateModal);
      cancelPresetBtn.addEventListener("click", closeEditModal);
      editPresetForm.addEventListener("submit", handlePresetFormSubmit);
    } catch (error) {
      console.error("Error initializing page:", error);
      alert("Error loading data: " + error.message);
    }
  });

  // Load menu items from API
  async function loadMenuItems() {
    try {
      const response = await fetch("/api/items");
      if (response.ok) {
        menuItems = await response.json();
      } else {
        throw new Error("Failed to load menu items");
      }
    } catch (error) {
      console.error("Error loading menu items:", error);
      throw error;
    }
  }

  // Load presets from API
  async function loadPresets() {
    try {
      const response = await fetch("/api/presets");
      if (response.ok) {
        presets = await response.json();
      } else {
        throw new Error("Failed to load presets");
      }
    } catch (error) {
      console.error("Error loading presets:", error);
      throw error;
    }
  }

  // Render presets table
  function renderPresetsTable() {
    presetsTableBody.innerHTML = "";

    if (presets.length === 0) {
      const row = document.createElement("tr");
      row.innerHTML =
        '<td colspan="4" class="text-center">No presets found</td>';
      presetsTableBody.appendChild(row);
      return;
    }

    presets.forEach((preset) => {
      const row = document.createElement("tr");
      const menuItemCount = preset.menu_item_ids.length;

      row.innerHTML = `
        <td>${preset.name}</td>
        <td>${preset.description}</td>
        <td>${menuItemCount} item${menuItemCount !== 1 ? "s" : ""}</td>
        <td>
          <button class="btn btn-secondary" onclick="editPreset('${
            preset.id
          }')">Edit</button>
          <button class="btn btn-error" onclick="deletePreset('${
            preset.id
          }')">Delete</button>
        </td>
      `;
      presetsTableBody.appendChild(row);
    });
  }

  // Open create preset modal
  function openCreateModal() {
    // Reset form
    editPresetForm.reset();
    document.getElementById("presetId").value = "";
    modalTitle.textContent = "Create New Preset";

    // Render menu items for selection
    renderMenuItemsSelection([]);

    // Show modal
    editPresetModal.style.display = "flex";

    // Focus on the first input field
    document.getElementById("presetName").focus();
  }

  // Edit preset
  function editPreset(id) {
    const preset = presets.find((p) => p.id === id);
    if (!preset) {
      alert("Preset not found");
      return;
    }

    // Fill form with preset data
    document.getElementById("presetId").value = preset.id;
    document.getElementById("presetName").value = preset.name;
    document.getElementById("presetDescription").value = preset.description;
    modalTitle.textContent = "Edit Preset";

    // Render menu items for selection with current selections
    renderMenuItemsSelection(preset.menu_item_ids);

    // Show modal
    editPresetModal.style.display = "flex";

    // Focus on the first input field
    document.getElementById("presetName").focus();
  }

  // Render menu items selection interface
  function renderMenuItemsSelection(selectedItemIds) {
    const container = document.getElementById("menuItemsContainer");
    container.innerHTML = "";

    if (menuItems.length === 0) {
      container.innerHTML = "<p>No menu items available</p>";
      return;
    }

    // Group menu items by category
    const categories = {};
    menuItems.forEach((item) => {
      if (!categories[item.category]) {
        categories[item.category] = [];
      }
      categories[item.category].push(item);
    });

    // Create checkboxes for each menu item
    Object.keys(categories).forEach((category) => {
      const categoryDiv = document.createElement("div");
      categoryDiv.className = "form-group";

      const categoryLabel = document.createElement("label");
      categoryLabel.textContent = category;
      categoryLabel.style.fontWeight = "bold";
      categoryDiv.appendChild(categoryLabel);

      categories[category].forEach((item) => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "form-check";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `item-${item.id}`;
        checkbox.name = "menu_items";
        checkbox.value = item.id;
        checkbox.className = "form-check-input";
        if (selectedItemIds.includes(item.id)) {
          checkbox.checked = true;
        }

        const label = document.createElement("label");
        label.htmlFor = `item-${item.id}`;
        label.textContent = `${item.name} - ${item.description}`;
        label.className = "form-check-label";

        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        categoryDiv.appendChild(itemDiv);
      });

      container.appendChild(categoryDiv);
    });
  }

  // Close edit modal
  function closeEditModal() {
    editPresetModal.style.display = "none";
  }

  // Close modal when pressing Escape key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && editPresetModal.style.display === "flex") {
      closeEditModal();
    }
  });

  // Handle preset form submission
  async function handlePresetFormSubmit(e) {
    e.preventDefault();

    // Get form data
    const formData = new FormData(editPresetForm);
    const presetId = formData.get("id");
    const name = formData.get("name");
    const description = formData.get("description");

    // Get selected menu item IDs
    const selectedItems = document.querySelectorAll(
      'input[name="menu_items"]:checked'
    );
    const menuItemIds = Array.from(selectedItems).map((item) => item.value);

    // Validate required fields
    if (!name || !description) {
      alert("Please fill in all required fields");
      return;
    }

    if (menuItemIds.length === 0) {
      alert("Please select at least one menu item");
      return;
    }

    // Prepare data for API
    const presetData = {
      name: name,
      description: description,
      menu_item_ids: menuItemIds,
    };

    try {
      let response;

      if (presetId) {
        // Update existing preset
        response = await fetch(`/api/presets/${presetId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(presetData),
        });
      } else {
        // Create new preset
        response = await fetch("/api/presets", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(presetData),
        });
      }

      if (response.ok) {
        alert(
          presetId
            ? "Preset updated successfully"
            : "Preset created successfully"
        );
        closeEditModal();
        await loadPresets();
        renderPresetsTable();
      } else {
        const errorText = await response.text();
        throw new Error(errorText);
      }
    } catch (error) {
      console.error("Error saving preset:", error);
      alert("Error saving preset: " + error.message);
    }
  }

  // Delete preset
  async function deletePreset(id) {
    if (!confirm("Are you sure you want to delete this preset?")) {
      return;
    }

    try {
      const response = await fetch(`/api/presets/${id}`, {
        method: "DELETE",
        credentials: "include",
      });

      if (response.ok) {
        alert("Preset deleted successfully");
        await loadPresets();
        renderPresetsTable();
      } else {
        const errorText = await response.text();
        throw new Error(errorText);
      }
    } catch (error) {
      console.error("Error deleting preset:", error);
      alert("Error deleting preset: " + error.message);
    }
  }
</script>
{% endblock %}
